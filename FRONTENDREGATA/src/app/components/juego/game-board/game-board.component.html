<div class="game-board-container">
  @if (loading()) {
    <div class="loading">Cargando mapa...</div>
  }

  @if (error()) {
    <div class="error">{{ error() }}</div>
  }

  @if (mapa() && !loading()) {
    <div class="game-info">
      <h2>{{ mapa()!.nombre }}</h2>
      <div class="map-info">
        <span>Dimensiones: {{ mapa()!.getTamFilas() }} x {{ mapa()!.getTamColumnas() }}</span>
      </div>
    </div>

    <div class="game-board">
      <div class="map-grid" 
           [style.grid-template-columns]="'repeat(' + mapa()!.getTamColumnas() + ', 1fr)'"
           [style.grid-template-rows]="'repeat(' + mapa()!.getTamFilas() + ', 1fr)'">
        
            @for (row of [].constructor(mapa()!.getTamFilas()); track $index; let x = $index) {
              @for (col of [].constructor(mapa()!.getTamColumnas()); track $index; let y = $index) {
                @let tipo = getTipoCelda(x, y);
                @let esSeleccionable = esCeldaSeleccionable(x, y);
                @let esSeleccionada = celdaSeleccionada() && celdaSeleccionada()!.x === x && celdaSeleccionada()!.y === y;

                <div class="cell"
                     [style.background-color]="getColorCelda(tipo)"
                     [class.wall]="tipo === 'PARED'"
                     [class.start]="tipo === 'PARTIDA'"
                     [class.goal]="tipo === 'META'"
                     [class.water]="tipo === 'AGUA'"
                     [class.selectable]="esSeleccionable"
                     [class.selected]="esSeleccionada"
                     [class.current-position]="estadoActual() && estadoActual()!.posX === x && estadoActual()!.posY === y"
                     (click)="seleccionarCelda(x, y)"
                     [title]="getTooltipCelda(x, y, tipo)">

                  @if (tipo !== 'AGUA') {
                    <span class="cell-symbol">{{ getSimboloCelda(tipo) }}</span>
                  }

                  <!-- Posici√≥n anterior del barco -->
                  @if (estadoAnterior() && estadoAnterior()!.posX === x && estadoAnterior()!.posY === y) {
                    <div class="previous-position">üìç</div>
                  }

                  <!-- Posici√≥n actual del barco -->
                  @if (estadoActual() && estadoActual()!.posX === x && estadoActual()!.posY === y) {
                    <div class="boat">üö¢</div>
                  }

                  <!-- Indicador de destino seleccionado -->
                  @if (esSeleccionada) {
                    <div class="destination">üéØ</div>
                  }

                  <!-- Indicador de casillas seleccionables -->
                  @if (esSeleccionable && !esSeleccionada && !(estadoActual() && estadoActual()!.posX === x && estadoActual()!.posY === y)) {
                    <div class="selectable-indicator">‚ú®</div>
                  }
                </div>
              }
            }
      </div>
    </div>

        <!-- Controles de movimiento - Solo en modo juego activo -->
        @if (isModoJuego()) {
          <div class="movement-controls">
            <h3>Controles de Movimiento</h3>
            
            <div class="click-instructions">
              <p>üéØ <strong>Haz clic en una casilla verde (‚ú®) para seleccionar tu destino</strong></p>
            </div>

            <div class="movement-preview">
              @if (celdaSeleccionada()) {
                <div class="preview-text">
                  <strong>Destino seleccionado:</strong> {{ getDestinoPreview() }}
                </div>
                @if (mensajeValidacion()) {
                  <div class="validation-message" 
                       [class.valid]="movimientoValido()"
                       [class.invalid]="!movimientoValido()">
                    {{ mensajeValidacion() }}
                  </div>
                }
              } @else {
                <div class="preview-text no-selection">
                  Selecciona una casilla en el mapa para moverte
                </div>
              }
            </div>

            <button class="btn btn-primary btn-move" 
                    (click)="realizarMovimiento()" 
                    [disabled]="loading() || !celdaSeleccionada() || !movimientoValido()">
              @if (loading()) {
                üö¢ Navegando...
              } @else {
                üö¢ Navegar a Destino
              }
            </button>

            @if (celdaSeleccionada()) {
              <button class="btn btn-secondary btn-clear" 
                      (click)="limpiarSeleccion()">
                ‚ùå Cancelar Selecci√≥n
              </button>
            }
          </div>

          <!-- Estado anterior -->
          @if (estadoAnterior()) {
            <div class="game-status previous">
              <h3>üìú Estado Anterior</h3>
              <div class="status-info">
                <div class="status-item">
                  <strong>Posici√≥n:</strong> {{ getPosicionAnterior() }}
                </div>
                <div class="status-item">
                  <strong>Velocidad:</strong> {{ getVelocidadAnterior() }}
                </div>
                <div class="status-item">
                  <strong>Turno:</strong> {{ estadoAnterior()!.turno }}
                </div>
                <div class="status-item">
                  <strong>Colisi√≥n:</strong> {{ estadoAnterior()!.colision ? 'S√≠' : 'No' }}
                </div>
              </div>
            </div>
          }

          <!-- Estado actual -->
          <div class="game-status">
            <h3>üìç Estado Actual</h3>
            <div class="status-info">
              <div class="status-item">
                <strong>Posici√≥n:</strong> {{ getPosicionActual() }}
              </div>
              <div class="status-item">
                <strong>Velocidad:</strong> {{ getVelocidadActual() }}
              </div>
              @if (estadoActual()) {
                <div class="status-item">
                  <strong>Turno:</strong> {{ estadoActual()!.turno }}
                </div>
                <div class="status-item">
                  <strong>Colisi√≥n:</strong> {{ estadoActual()!.colision ? 'S√≠' : 'No' }}
                </div>
              }
            </div>
            
            <!-- Informaci√≥n sobre velocidad acumulada -->
            <div class="velocity-info">
              <h4>üí° C√≥mo funciona la velocidad:</h4>
              <ul>
                <li><strong>Velocidad (0,0):</strong> Te mueves 1 casilla por turno</li>
                <li><strong>Velocidad (1,0):</strong> Te mueves 2 casillas hacia la derecha</li>
                <li><strong>Velocidad (3,2):</strong> Te mueves 4 casillas derecha + 3 abajo</li>
                <li><strong>Cambio por turno:</strong> m√°ximo ¬±1 por eje (la velocidad se acumula!)</li>
                <li><strong>Estrategia:</strong> Acelera gradualmente hacia destinos lejanos</li>
              </ul>
              <p><em>üéØ La velocidad puede crecer indefinidamente - ¬°planifica tus movimientos!</em></p>
            </div>
          </div>
        } @else {
          <!-- Modo visualizaci√≥n - Solo mostrar informaci√≥n del mapa -->
          <div class="map-info-only">
            <h3>Vista del Mapa</h3>
            <p>Este es el mapa de la regata. Para jugar, crea una partida desde la secci√≥n "Partidas".</p>
            <div class="map-legend">
              <div class="legend-item">
                <span class="legend-color agua"></span>
                <span>Agua - Navegable</span>
              </div>
              <div class="legend-item">
                <span class="legend-color pared"></span>
                <span>Pared - Obst√°culo</span>
              </div>
              <div class="legend-item">
                <span class="legend-color partida"></span>
                <span>P - Punto de Partida</span>
              </div>
              <div class="legend-item">
                <span class="legend-color meta"></span>
                <span>M - Meta</span>
              </div>
            </div>
          </div>
        }
  }
</div>
