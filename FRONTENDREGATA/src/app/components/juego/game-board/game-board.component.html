<div class="game-board-container">
  @if (loading()) {
    <div class="loading">Cargando mapa...</div>
  }

  @if (error()) {
    <div class="error">{{ error() }}</div>
  }

  @if (mapa() && !loading()) {
    <div class="game-info">
      <h2>{{ mapa()!.nombre }}</h2>
      <div class="map-info">
        <span>Dimensiones: {{ mapa()!.getTamFilas() }} x {{ mapa()!.getTamColumnas() }}</span>
      </div>
    </div>

    <div class="game-board">
      <div class="map-grid" 
           [style.grid-template-columns]="'repeat(' + mapa()!.getTamColumnas() + ', 1fr)'"
           [style.grid-template-rows]="'repeat(' + mapa()!.getTamFilas() + ', 1fr)'">
        
            @for (row of [].constructor(mapa()!.getTamFilas()); track $index; let x = $index) {
              @for (col of [].constructor(mapa()!.getTamColumnas()); track $index; let y = $index) {
                @let tipo = getTipoCelda(x, y);
                @let esSeleccionable = esCeldaSeleccionable(x, y);
                @let esSeleccionada = celdaSeleccionada() && celdaSeleccionada()!.x === x && celdaSeleccionada()!.y === y;
                @let esColisionInevitable = esColisionInevitableEn(x, y);

                <div class="cell"
                     [style.background-color]="getColorCelda(tipo)"
                     [class.wall]="tipo === 'PARED'"
                     [class.start]="tipo === 'PARTIDA'"
                     [class.goal]="tipo === 'META'"
                     [class.water]="tipo === 'AGUA'"
                     [class.selectable]="esSeleccionable"
                     [class.selected]="esSeleccionada"
                     [class.current-position]="estadoActual() && estadoActual()!.posX === x && estadoActual()!.posY === y"
                     [class.inevitable-collision]="esColisionInevitable"
                     (click)="seleccionarCelda(x, y)"
                     [title]="getTooltipCelda(x, y, tipo)">

                  @if (tipo !== 'AGUA') {
                    <span class="cell-symbol">{{ getSimboloCelda(tipo) }}</span>
                  }

                  <!-- PosiciÃ³n anterior del barco -->
                  @if (estadoAnterior() && estadoAnterior()!.posX === x && estadoAnterior()!.posY === y) {
                    <div class="previous-position">ğŸ“</div>
                  }

                  <!-- PosiciÃ³n actual del barco -->
                  @if (estadoActual() && estadoActual()!.posX === x && estadoActual()!.posY === y) {
                    <div class="boat">ğŸš¢</div>
                  }

                  <!-- Indicador de destino seleccionado -->
                  @if (esSeleccionada) {
                    <div class="destination">ğŸ¯</div>
                  }

                  <!-- Indicador de colisiÃ³n inevitable -->
                  @if (esColisionInevitable) {
                    <div class="inevitable-collision-indicator">ğŸ’¥</div>
                  }

                  <!-- Indicador de casillas seleccionables -->
                  @if (esSeleccionable && !esSeleccionada && !(estadoActual() && estadoActual()!.posX === x && estadoActual()!.posY === y) && !esColisionInevitable) {
                    <div class="selectable-indicator">âœ¨</div>
                  }
                </div>
              }
            }
      </div>
    </div>

        <!-- Controles de movimiento - Solo en modo juego activo -->
        @if (isModoJuego()) {
          <div class="movement-controls">
            <h3>Controles de Movimiento</h3>
            
            <div class="click-instructions">
              <p>ğŸ¯ <strong>Haz clic en una casilla verde (âœ¨) para seleccionar tu destino</strong></p>
              <p>ğŸ’¥ <strong>Las casillas rojas (ğŸ’¥) indican colisiones inevitables</strong></p>
              <p><small>Destinos disponibles: {{ destinosPosibles().length }} opciones</small></p>
            </div>

            <div class="movement-preview">
              @if (celdaSeleccionada()) {
                <div class="preview-text">
                  <strong>Destino seleccionado:</strong> {{ getDestinoPreview() }}
                </div>
                @if (mensajeValidacion()) {
                  <div class="validation-message" 
                       [class.valid]="movimientoValido()"
                       [class.invalid]="!movimientoValido()">
                    {{ mensajeValidacion() }}
                  </div>
                }
              } @else {
                <div class="preview-text no-selection">
                  Selecciona una casilla en el mapa para moverte
                </div>
              }
            </div>

            <button class="btn btn-primary btn-move" 
                    (click)="realizarMovimiento()" 
                    [disabled]="loading() || !celdaSeleccionada() || !movimientoValido()">
              @if (loading()) {
                ğŸš¢ Navegando...
              } @else {
                ğŸš¢ Navegar a Destino
              }
            </button>

            @if (celdaSeleccionada()) {
              <button class="btn btn-secondary btn-clear" 
                      (click)="limpiarSeleccion()">
                âŒ Cancelar SelecciÃ³n
              </button>
            }
          </div>

          <!-- Estado anterior -->
          @if (estadoAnterior()) {
            <div class="game-status previous">
              <h3>ğŸ“œ Estado Anterior</h3>
              <div class="status-info">
                <div class="status-item">
                  <strong>PosiciÃ³n:</strong> {{ getPosicionAnterior() }}
                </div>
                <div class="status-item">
                  <strong>Velocidad:</strong> {{ getVelocidadAnterior() }}
                </div>
                <div class="status-item">
                  <strong>Turno:</strong> {{ estadoAnterior()!.turno }}
                </div>
                <div class="status-item">
                  <strong>ColisiÃ³n:</strong> {{ estadoAnterior()!.colision ? 'SÃ­' : 'No' }}
                </div>
              </div>
            </div>
          }

          <!-- Estado actual -->
          <div class="game-status">
            <h3>ğŸ“ Estado Actual</h3>
            <div class="status-info">
              <div class="status-item">
                <strong>PosiciÃ³n:</strong> {{ getPosicionActual() }}
              </div>
              <div class="status-item">
                <strong>Velocidad:</strong> {{ getVelocidadActual() }}
              </div>
              @if (estadoActual()) {
                <div class="status-item">
                  <strong>Turno:</strong> {{ estadoActual()!.turno }}
                </div>
                <div class="status-item">
                  <strong>ColisiÃ³n:</strong> {{ estadoActual()!.colision ? 'SÃ­' : 'No' }}
                </div>
              }
            </div>
            
            <!-- InformaciÃ³n sobre velocidad acumulada -->
            <div class="velocity-info">
              <h4>ğŸ’¡ CÃ³mo funciona la velocidad:</h4>
              <ul>
                <li><strong>Velocidad (0,0):</strong> Te mueves 1 casilla por turno</li>
                <li><strong>Velocidad (1,0):</strong> Te mueves 2 casillas hacia la derecha</li>
                <li><strong>Velocidad (3,2):</strong> Te mueves 4 casillas derecha + 3 abajo</li>
                <li><strong>Cambio por turno:</strong> mÃ¡ximo Â±1 por eje (la velocidad se acumula!)</li>
                <li><strong>Estrategia:</strong> Acelera gradualmente hacia destinos lejanos</li>
              </ul>
              <p><em>ğŸ¯ La velocidad puede crecer indefinidamente - Â¡planifica tus movimientos!</em></p>
            </div>
          </div>
        } @else {
          <!-- Modo visualizaciÃ³n - Solo mostrar informaciÃ³n del mapa -->
          <div class="map-info-only">
            <h3>Vista del Mapa</h3>
            <p>Este es el mapa de la regata. Para jugar, crea una partida desde la secciÃ³n "Partidas".</p>
            <div class="map-legend">
              <div class="legend-item">
                <span class="legend-color agua"></span>
                <span>Agua - Navegable</span>
              </div>
              <div class="legend-item">
                <span class="legend-color pared"></span>
                <span>Pared - ObstÃ¡culo</span>
              </div>
              <div class="legend-item">
                <span class="legend-color partida"></span>
                <span>P - Punto de Partida</span>
              </div>
              <div class="legend-item">
                <span class="legend-color meta"></span>
                <span>M - Meta</span>
              </div>
            </div>
          </div>
        }
  }

    <!-- Banner de victoria/derrota -->
    @if (juegoTerminado()) {
      <div class="game-result-banner" [class.win]="resultadoJuego() === 'ganado'" [class.lose]="resultadoJuego() === 'perdido'">
        <div class="banner-content">
          @if (resultadoJuego() === 'ganado') {
            <h2>ğŸ‰ Â¡FELICIDADES! Â¡GANASTE! ğŸ‰</h2>
            <p>Â¡Llegaste a la meta! Â¡Excelente navegaciÃ³n!</p>
          } @else if (resultadoJuego() === 'perdido') {
            <h2>ğŸ’¥ Â¡PERDISTE! ğŸ’¥</h2>
            <p>Tu barco chocÃ³ o saliÃ³ del mapa. Â¡IntÃ©ntalo de nuevo!</p>
          }
          <button class="btn btn-primary btn-restart" (click)="reiniciarJuego()">
            ğŸ”„ Jugar de Nuevo
          </button>
        </div>
      </div>
    }
</div>
